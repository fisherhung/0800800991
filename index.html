<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬çš„èŠ±è“®äººè¡Œé“åœ–è³‡ç³»çµ± v5.0.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --deep-blue: #0f172a; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; font-size: 17px; text-align: left; }
        #map { height: 100%; width: 100%; background: #cbd5e1; transition: width 0.4s ease; }
        .sidebar { width: 480px; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1500; display: flex; flex-direction: column; height: 100%; }
        .sidebar.collapsed { margin-left: -480px; }
        .btn-unified { background-color: var(--deep-blue); color: white; transition: all 0.2s; }
        .btn-unified:hover { background-color: #000000; transform: translateY(-1px); }
        .filter-chip { transition: all 0.2s; cursor: pointer; white-space: nowrap; font-weight: 700; border: 2px solid transparent; }
        .filter-chip.active { background-color: var(--deep-blue) !important; color: white !important; border-color: var(--deep-blue); }
        .op-filter-chip { transition: all 0.2s; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 14px; border: 1px solid #e2e8f0; }
        .op-filter-chip.active { background-color: #4f46e5 !important; color: white !important; border-color: #4f46e5; }
        .type-tab { cursor: pointer; padding: 12px 0; font-weight: 900; border-bottom: 4px solid transparent; transition: 0.3s; color: #94a3b8; font-size: 18px; text-align: center; }
        .type-tab.active { color: var(--deep-blue); border-bottom-color: var(--deep-blue); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .loading-screen { position: fixed; inset: 0; background: var(--deep-blue); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .leaflet-tooltip-custom { background: var(--deep-blue); color: white; border: none; border-radius: 6px; padding: 4px 10px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* æ‘ºç–Šéæ¸¡æ•ˆæœ */
        #collapsible-tools { transition: max-height 0.3s ease-out, opacity 0.2s ease-in; overflow: hidden; }
        #collapsible-tools.collapsed { max-height: 0; opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="text-slate-900 overflow-hidden h-screen flex flex-col">

    <!-- åŠ è¼‰é®ç½© -->
    <div id="loading" class="loading-screen">
        <div class="w-16 h-16 border-4 border-slate-700 border-t-white rounded-full animate-spin mb-6"></div>
        <p class="text-2xl font-black tracking-widest uppercase">ç³»çµ±å³æ™‚åŒæ­¥ä¸­...</p>
        <p id="loading-msg" class="text-sm text-slate-400 mt-2"></p>
    </div>

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="h-24 bg-white border-b border-slate-200 flex items-center justify-between px-10 z-[2000] shrink-0">
        <div class="flex items-center gap-6 text-left">
            <button id="toggle-sidebar" class="p-3 hover:bg-slate-100 rounded-xl transition-all">
                <i data-lucide="menu" class="h-8 w-8 text-slate-700"></i>
            </button>
            <div class="flex flex-col">
                <h1 class="text-3xl font-black tracking-tight text-[#0f172a]">èŠ±è“®äººè¡Œé“ <span class="text-slate-500 font-medium">åœ–è³‡å”ä½œç³»çµ±</span></h1>
                <span class="text-xs font-bold text-slate-400 tracking-widest uppercase">Infrastructure Management Multi-User Sync</span>
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3 bg-slate-30 px-6 py-3 rounded-2xl border border-slate-100 shadow-sm text-left">
                <div class="flex flex-col items-start">
                    <span class="text-[12px] font-black text-slate-500 uppercase leading-none mb-1 tracking-widest">Operator</span>
                    <select id="user-select" class="bg-transparent border-none font-black outline-none min-w-[150px] text-xl text-[#0f172a] cursor-pointer appearance-none">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
                <div class="flex gap-1 border-l border-slate-200 pl-4 ml-2">
                    <button onclick="openOpManager()" class="p-2 hover:bg-white rounded-lg transition-all text-slate-400 hover:text-[#0f172a]">
                        <i data-lucide="settings-2" class="h-7 w-7"></i>
                    </button>
                </div>
            </div>
            <div id="db-status" class="flex items-center gap-2">
                <div id="db-status-dot" class="w-2.5 h-2.5 rounded-full bg-slate-200"></div>
                <span id="db-status-text" class="text-[11px] font-black text-slate-200 uppercase tracking-tighter">Connecting</span>
            </div>
        </div>
    </header>

    <div class="flex flex-1 relative overflow-hidden">
        <aside id="sidebar" class="sidebar bg-white border-r border-slate-200 flex flex-col shrink-0">
<!-- å›ºå®šé ‚éƒ¨å€åŸŸ -->
    <div class="shrink-0">
        <div class="p-6 pb-0">
            <!-- ç³»çµ±èªªæ˜æ›¸æ•´åˆæ‘ºç–Šé¢æ¿ -->
            <details class="bg-slate-50 border-l-4 border-[#0f172a] rounded-2xl overflow-hidden group mb-4">
                <summary class="list-none p-4 cursor-pointer flex justify-between items-center hover:bg-slate-100 transition-colors">
                    <span class="font-black text-slate-700 text-lg">ç³»çµ±ä½¿ç”¨èªªæ˜èˆ‡è¦ç¯„ğŸ“–</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 group-open:rotate-180 transition-transform"><path d="m6 9 6 6 6-6"/></svg>
                </summary>
                <div class="p-5 pt-0 text-base text-slate-600 space-y-4 border-t border-slate-200 text-left">
                    <!-- QGIS æµç¨‹ -->
                    <div class="mt-4">
                        <p class="font-bold text-slate-800 mb-2 flex items-center">
                            <span class="w-1.5 h-1.5 bg-[#0f172a] rounded-full mr-2"></span>
                            ä¸€ã€ QGIS è…³æœ¬åŒ¯å‡º
                        </p>
                        <div class="pl-4 space-y-1 text-sm">
                            <p>1. <b>é¸å–åœ–å±¤ï¼š</b>åœ¨ QGIS å…§é»é¸ç›®æ¨™åœ–å±¤ã€‚</p>
                            <p>2. <b>åŸ·è¡Œè…³æœ¬ï¼š</b>ä½¿ç”¨ <code>Qgis.py</code>ã€‚</p>
                            <p>3. <b>å–å¾—æª”æ¡ˆï¼š</b>ç¢ºèªæŒ‡å®šè³‡æ–™å¤¾ç”Ÿæˆå°æ‡‰ JSON èˆ‡ PNGã€‚</p>
                        </div>
                    </div>

                    <!-- ç³»çµ±åŒ¯å…¥ -->
                    <div class="mt-4">
                        <p class="font-bold text-slate-800 mb-2 flex items-center">
                            <span class="w-1.5 h-1.5 bg-[#0f172a] rounded-full mr-2"></span>
                            äºŒã€ ç³»çµ±åŒ¯å…¥è¦ç¯„
                        </p>
                        <div class="pl-4 space-y-1 text-sm">
                            <p>1. <b>åŒ¯å…¥ JSONï¼š</b>è®€å–åæ¨™ä¸¦è‡ªå‹•å®šä½åœ°åœ–ã€‚</p>
                            <p>2. <b>ä¸Šå‚³ PNGï¼š</b>ç–ŠåŠ åº•åœ–ï¼ˆç³»çµ±è‡ªå‹•å£“ç¸®é«”ç©ï¼‰ã€‚</p>
                        </div>
                    </div>

                    <!-- æ³¨æ„äº‹é … -->
                    <div class="mt-4 bg-amber-100/50 p-3 rounded-xl border border-amber-200">
                        <p class="font-bold text-amber-900 mb-2 flex items-center">
                            <span class="mr-2">âš ï¸</span>é‡è¦æ³¨æ„äº‹é …
                        </p>
                        <div class="pl-1 space-y-2 text-sm text-amber-900">
                            <p>â— <b>åº§æ¨™ç³»çµ±ï¼š</b>çµ±ä¸€æ¡ç”¨ <b>EPSG:3826</b>ï¼Œåš´ç¦ä½¿ç”¨æœªç¶“è…³æœ¬è½‰æ›ä¹‹ç¶“ç·¯åº¦ã€‚</p>
                            <p>â— <b>æª”åè¦ç¯„ï¼š</b>è«‹å‹¿æ›´å‹•è…³æœ¬ç”Ÿæˆçš„æª”åï¼Œä»¥ç¶­æŒ JSON èˆ‡ PNG é…å°ã€‚</p>
                            <p>â— <b>è‡ªå‹•åŒæ­¥ï¼š</b>æ‰€æœ‰æ“ä½œå‡æœƒå³æ™‚å„²å­˜è‡³é›²ç«¯ã€‚</p>
                        </div>
                    </div>

                    <!-- ç³»çµ±åŠŸèƒ½ -->
                    <div class="mt-4 pt-4 border-t border-slate-200 text-sm">
                        <p><b>â— åœ–ç‰‡æ§åˆ¶ï¼š</b>è‡ªå‹•å°‡ PNG å£“ç¸®è‡³ 1MB å…§ã€‚</p>
                        <p><b>â— äººå“¡ç¯©é¸ï¼š</b>å¯ä¾ä½œæ¥­å“¡æ¨™ç±¤éæ¿¾è·¯æ®µã€‚</p>
                    </div>
                </div>
            </details>
        </div>

                <!-- ç‹€æ…‹ç¯©é¸ -->
                <div class="px-6 py-4 flex gap-2 overflow-x-auto custom-scrollbar no-scrollbar">
                    <div onclick="setFilter('all')" class="filter-chip active px-5 py-2 rounded-lg text-base bg-slate-100 text-slate-500" data-filter="all">å…¨éƒ¨ç‹€æ…‹</div>
                    <div onclick="setFilter('none')" class="filter-chip px-5 py-2 rounded-lg text-base bg-slate-100 text-slate-500" data-filter="none">å¾…è™•ç†</div>
                    <div onclick="setFilter('claimed')" class="filter-chip px-5 py-2 rounded-lg text-base bg-slate-100 text-slate-500" data-filter="claimed">é€²è¡Œä¸­</div>
                    <div onclick="setFilter('done')" class="filter-chip px-5 py-2 rounded-lg text-base bg-slate-100 text-slate-500" data-filter="done">å·²å®Œå·¥</div>
                </div>

                <!-- ä½œæ¥­å“¡ç¯©é¸åˆ— -->
                <div class="px-6 pb-4 flex gap-2 overflow-x-auto custom-scrollbar" id="op-filter-list"></div>

                <div class="flex px-6 border-b border-slate-100 items-center">
                    <div onclick="setTypeTab('img')" class="type-tab active flex-1" data-type="img">PNG åº•åœ–ç®¡ç†</div>
                    <div onclick="setTypeTab('point')" class="type-tab flex-1" data-type="point">é»ä½åœ–å±¤</div>
                    <!-- æ‘ºç–ŠæŒ‰éˆ• -->
                    <button onclick="toggleCollapsibleTools()" class="p-2 ml-2 hover:bg-slate-100 rounded-lg text-slate-400 transition-all" title="å±•é–‹/æ‘ºç–ŠåŠŸèƒ½æŒ‰éˆ•">
                        <i id="fold-icon" data-lucide="chevron-up" class="h-6 w-6 transition-transform"></i>
                    </button>
                </div>

                <!-- å¯æ‘ºç–Šçš„åŠŸèƒ½å€åŸŸ -->
                <div id="collapsible-tools" class="max-h-[500px]">
                    <div class="p-6 grid grid-cols-2 gap-3">
                        <button onclick="triggerFile('file-input')" class="btn-unified py-4 rounded-xl shadow-lg font-black text-sm uppercase">1. åŒ¯å…¥ JSON åº§æ¨™</button>
                        <button onclick="triggerFile('img-input')" class="btn-unified py-4 rounded-xl shadow-lg font-black text-sm uppercase">2. ä¸Šå‚³ PNG åº•åœ–</button>
                        <button onclick="triggerFile('point-input')" class="col-span-2 bg-indigo-600 text-white py-4 rounded-xl shadow-lg font-black text-xl uppercase hover:bg-indigo-700">åŒ¯å…¥é»ä½åœ–å±¤ (GeoJSON)</button>
                        
                        <input type="file" id="file-input" class="hidden" accept=".json">
                        <input type="file" id="img-input" class="hidden" accept="image/png">
                        <input type="file" id="point-input" class="hidden" accept=".geojson,.json,.csv">
                    </div>

                    <div class="px-8 py-5 border-y border-slate-100 bg-slate-50/50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Global Progress</span>
                            <span id="stat-percent" class="text-2xl font-black text-[#0f172a]">0%</span>
                        </div>
                        <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ»¾å‹•å…§å®¹å€åŸŸ (æœƒéš¨è‘—ä¸Šæ–¹æ‘ºç–Šè‡ªå‹•å»¶å±•) -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-slate-50/30" id="asset-list"></div>
        </aside>

        <main class="flex-1 relative">
            <div id="map"></div>
            
            <!-- æ“ä½œé¢æ¿ -->
            <div id="action-panel" class="absolute bottom-8 left-8 bg-white p-10 rounded-[40px] shadow-2xl border border-slate-100 z-[2000] w-[450px] hidden text-left">
                <div class="mb-8 flex justify-between items-start">
                    <div class="flex-1 truncate">
                        <h3 id="ui-name" class="text-3xl font-black text-[#0f172a] mb-2 truncate">è·¯æ®µåç¨±</h3>
                        <div id="ui-badge" class="inline-block px-5 py-3 rounded-full text-lg font-black uppercase tracking-widest bg-slate-100 text-slate-400">LOADING</div>
                    </div>
                </div>
                <div class="space-y-4">
                    <button id="btn-claim" onclick="updateStatus('claimed')" class="btn-unified w-full py-6 rounded-2xl font-black text-2xl shadow-xl">èªé ˜æ­¤å€å¡Š</button>
                    <button id="btn-done" onclick="updateStatus('done')" class="w-full bg-emerald-600 text-white py-6 rounded-2xl font-black text-2xl hover:bg-emerald-700 shadow-xl transition-colors">æ¨™è¨˜å·²å®Œå·¥</button>
                    <div class="flex gap-3 mt-4">
                        <button onclick="updateStatus('none')" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-xl font-bold text-base hover:bg-slate-200">å–æ¶ˆèªé ˜</button>
                        <button onclick="closePanel()" class="flex-1 border border-slate-200 text-slate-400 py-4 rounded-xl font-bold text-base">é—œé–‰é¢æ¿</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å„²å­˜ Modal -->
    <div id="save-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[3000] hidden flex items-center justify-center p-6">
        <div class="bg-white rounded-[48px] p-12 max-w-md w-full shadow-2xl text-center">
            <h3 id="modal-title" class="text-3xl font-black mb-2 text-[#0f172a]">å„²å­˜è‡³é›²ç«¯åº«</h3>
            <p id="modal-desc" class="text-slate-400 mb-8 font-medium text-sm">è«‹ç¢ºèªæ­¤åœ–å±¤çš„é¡¯ç¤ºåç¨±</p>
            <input type="text" id="save-name" class="w-full bg-slate-50 border-2 border-slate-100 p-5 rounded-2xl font-black text-2xl text-center outline-none focus:border-slate-300 text-[#0f172a] mb-8" placeholder="è¼¸å…¥åç¨±...">
            
            <div id="compression-info" class="mb-6 p-4 bg-blue-50 rounded-2xl text-blue-700 font-bold text-sm hidden">
                æ­£åœ¨é€²è¡Œæ™ºèƒ½å£“ç¸®ï¼Œè«‹ç¨å€™...
            </div>

            <div id="upload-status" class="hidden mb-4 p-4 bg-amber-50 rounded-xl text-amber-700 font-bold text-sm">æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...</div>
            
            <button id="btn-final-upload" class="btn-unified w-full py-6 rounded-3xl font-black text-2xl shadow-xl">ç¢ºèªå„²å­˜ä¸¦åŒæ­¥</button>
            <button onclick="closeModal()" class="w-full mt-4 text-slate-400 font-bold text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä½œæ¥­å“¡ç®¡ç† Modal -->
    <div id="op-manager-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[5000] hidden flex items-center justify-center p-6">
        <div class="bg-white rounded-[40px] p-10 max-w-md w-full shadow-2xl flex flex-col h-[80vh]">
            <div class="shrink-0 mb-6 flex justify-between items-start text-left">
                <div>
                    <h3 class="text-2xl font-black text-[#0f172a]">äººå“¡ç®¡ç†</h3>
                    <p class="text-sm text-slate-400">æ–°å¢æˆ–ç§»é™¤å¯é¸çš„ä½œæ¥­å“¡åå–®</p>
                </div>
                <button onclick="closeOpManager()" class="text-slate-300 hover:text-rose-500"><i data-lucide="x" class="h-8 w-8"></i></button>
            </div>
            <div class="shrink-0 mb-6 flex gap-2">
                <input type="text" id="new-op-name" class="flex-1 bg-slate-50 border-2 border-slate-100 p-4 rounded-xl font-bold text-lg" placeholder="æ–°ä½œæ¥­å“¡å§“å">
                <button onclick="addOperator()" class="bg-[#0f172a] text-white px-6 rounded-xl font-black text-lg">æ–°å¢</button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2" id="op-list"></div>
            <button onclick="closeOpManager()" class="mt-8 w-full py-5 border-2 border-slate-100 text-slate-400 font-black rounded-2xl text-lg">é—œé–‰</button>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = {
            apiKey: "AIzaSyCxKDeztaXjFWvCCnCFztpN9Z08uWLVJRU",
            authDomain: "hualien-sideealk.firebaseapp.com",
            projectId: "hualien-sideealk",
            storageBucket: "hualien-sideealk.firebasestorage.app",
            messagingSenderId: "1022792116904",
            appId: "1:1022792116904:web:a746f55eb674ec0d2e709d"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : DEFAULT_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hualien-sidewalk-final';
        
        proj4.defs("EPSG:3826", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs");

        let map, db, auth, currentUser = null;
        let assets = new Map();
        let operators = [];
        let activeId = null, currentFilter = 'all', currentTypeTab = 'img', currentOpFilter = 'all';
        let pendingJson = null, pendingImg = null, pendingPoints = null, editModeId = null;

        async function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([23.975, 121.605], 14);
            L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);

            document.getElementById('toggle-sidebar').onclick = () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
                setTimeout(() => map.invalidateSize(), 400);
            };

            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    if (user) {
                        updateStatusVisuals(true);
                        startDataSync();
                        startOperatorSync();
                    }
                });
            } catch (err) { updateStatusVisuals(false); }
            lucide.createIcons();
        }

        // æ–°å¢ï¼šæ‘ºç–Šé¢æ¿æ§åˆ¶é‚è¼¯
        function toggleCollapsibleTools() {
            const container = document.getElementById('collapsible-tools');
            const icon = document.getElementById('fold-icon');
            const isCollapsed = container.classList.toggle('collapsed');
            
            icon.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function updateStatusVisuals(online) {
            const dot = document.getElementById('db-status-dot');
            const text = document.getElementById('db-status-text');
            dot.className = online ? 'w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse' : 'w-2.5 h-2.5 rounded-full bg-rose-500';
            text.innerText = online ? 'Cloud Syncing' : 'Offline';
            text.className = online ? 'text-[11px] font-black text-emerald-600' : 'text-[11px] font-black text-rose-500';
        }

        function startDataSync() {
            const baseRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
            baseRef.collection('assets').onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    const id = change.doc.id, data = change.doc.data();
                    if (change.type === 'added') data.points ? addPointLayer(id, data) : addImgLayer(id, data);
                    if (change.type === 'removed') removeLayer(id);
                    if (change.type === 'modified') {
                        if (assets.has(id)) {
                            assets.get(id).name = data.displayName;
                            if (assets.get(id).type === 'img') assets.get(id).rect.setTooltipContent(data.displayName);
                        }
                    }
                });
                renderUI();
                document.getElementById('loading').style.display = 'none';
            }, err => console.error("Data sync error:", err));

            baseRef.collection('status').onSnapshot(snap => {
                snap.forEach(doc => { if (assets.has(doc.id)) assets.get(doc.id).statusData = doc.data(); });
                renderUI();
            });
        }

        function addImgLayer(id, data) {
            const { n, s, w, e } = data.json;
            const sw = proj4('EPSG:3826', 'WGS84', [w, s]), ne = proj4('EPSG:3826', 'WGS84', [e, n]);
            const bounds = L.latLngBounds([sw[1], sw[0]], [ne[1], ne[0]]);
            const overlay = L.imageOverlay(data.img, bounds, { opacity: 0.9, interactive: false }).addTo(map);
            const rect = L.rectangle(bounds, { color: '#0f172a', weight: 1.5, fillOpacity: 0.05 }).addTo(map);
            rect.bindTooltip(data.displayName, { className: 'leaflet-tooltip-custom', sticky: true });
            rect.on('click', () => openPanel(id));
            assets.set(id, { type: 'img', rect, overlay, bounds, name: data.displayName, statusData: null });
        }

        function addPointLayer(id, data) {
            const group = L.featureGroup().addTo(map);
            data.points.forEach(p => {
                const marker = L.circleMarker([p.lat, p.lng], { radius: 6, fillColor: "#4f46e5", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(group);
                if (p.name) marker.bindTooltip(p.name);
            });
            group.on('click', () => openPanel(id));
            assets.set(id, { type: 'point', visual: group, bounds: group.getBounds(), name: data.displayName, statusData: null });
        }

        function removeLayer(id) {
            const a = assets.get(id); if (!a) return;
            a.type === 'img' ? (map.removeLayer(a.rect), map.removeLayer(a.overlay)) : map.removeLayer(a.visual);
            assets.delete(id);
        }

        function renderUI() {
            const list = document.getElementById('asset-list');
            list.innerHTML = ""; let done = 0;
            const filtered = Array.from(assets.entries()).filter(([id, a]) => {
                const statusMatch = currentFilter === 'all' || (a.statusData?.status || 'none') === currentFilter;
                const typeMatch = currentTypeTab === a.type;
                const opMatch = currentOpFilter === 'all' || (a.statusData?.userName === currentOpFilter);
                if(a.statusData?.status === 'done') done++;
                return statusMatch && typeMatch && opMatch;
            });
            
            filtered.sort((a,b) => a[1].name.localeCompare(b[1].name)).forEach(([id, asset]) => {
                const s = asset.statusData, status = s ? s.status : 'none';
                const card = document.createElement('div');
                card.className = `flex items-center gap-4 p-6 rounded-2xl border transition-all ${activeId === id ? 'bg-slate-100 border-slate-300' : 'bg-white border-slate-100 hover:border-slate-200 cursor-pointer'}`;
                let dot = 'bg-slate-200', sub = 'ç­‰å¾…èªé ˜', subClass = 'text-slate-400';
                if(status === 'claimed') { dot = 'bg-amber-400'; sub = `ğŸ‘· ${s.userName || 'ä½œæ¥­ä¸­'}`; subClass = 'text-amber-600 font-black'; }
                if(status === 'done') { dot = 'bg-emerald-500'; sub = `âœ… ${s.userName || 'å·²å®Œå·¥'}`; subClass = 'text-emerald-600 font-black'; }
                card.innerHTML = `<div class="w-4 h-4 rounded-full ${dot} shrink-0"></div><div onclick="focusOn('${id}')" class="flex-1 truncate text-left"><h4 class="text-xl font-black text-[#0f172a] truncate mb-1">${asset.name}</h4><span class="text-lg uppercase tracking-tight ${subClass}">${sub}</span></div><div class="flex gap-2 shrink-0"><button onclick="editAssetName('${id}')" class="p-2 text-slate-300 hover:text-blue-500"><i data-lucide="edit-3" class="h-6 w-6"></i></button><button onclick="deleteAsset('${id}')" class="p-2 text-slate-300 hover:text-rose-500"><i data-lucide="trash-2" class="h-6 w-6"></i></button></div>`;
                list.appendChild(card);
                if (asset.type === 'img') asset.rect.setStyle({ color: status === 'done' ? '#10b981' : (status === 'claimed' ? '#f59e0b' : '#0f172a'), fillOpacity: status === 'none' ? 0.05 : 0.15 });
            });
            const p = assets.size ? Math.round((done / assets.size) * 100) : 0;
            document.getElementById('stat-percent').innerText = p + '%';
            document.getElementById('progress-bar').style.width = p + '%';
            lucide.createIcons();
        }

        function triggerFile(id) { document.getElementById(id).click(); }

        document.getElementById('file-input').onchange = async (e) => {
            const f = e.target.files[0];
            if (f) pendingJson = JSON.parse(await f.text());
        };

        document.getElementById('img-input').onchange = (e) => {
            const f = e.target.files[0];
            if (!f || !pendingJson) return alert("è«‹å…ˆåŒ¯å…¥ JSON åº§æ¨™æª”æ¡ˆ");
            
            const r = new FileReader();
            r.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    document.getElementById('compression-info').classList.remove('hidden');
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const maxDim = 1600; 
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = (maxDim / w) * h; w = maxDim; }
                        else { w = (maxDim / h) * w; h = maxDim; }
                    }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);

                    let quality = 0.9;
                    let resultData = canvas.toDataURL('image/png'); 
                    if (resultData.length > 1000000) {
                        while (resultData.length > 1000000 && quality > 0.1) {
                            resultData = canvas.toDataURL('image/jpeg', quality);
                            quality -= 0.1;
                        }
                    }
                    pendingImg = resultData;
                    document.getElementById('compression-info').classList.add('hidden');
                    document.getElementById('save-name').value = pendingJson.name || f.name.split('.')[0];
                    document.getElementById('save-modal').classList.remove('hidden');
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        };

        document.getElementById('point-input').onchange = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            let points = [];
            try {
                if (ext === 'csv') {
                    const results = Papa.parse(await file.text(), { header: true, skipEmptyLines: true });
                    results.data.forEach(row => {
                        let x = parseFloat(row.x || row.X || row.lng || row.longitude), y = parseFloat(row.y || row.Y || row.lat || row.latitude);
                        if (x > 180) { const c = proj4('EPSG:3826', 'WGS84', [x, y]); x = c[0]; y = c[1]; }
                        if (!isNaN(x)) points.push({ lat: y, lng: x, name: row.name || "" });
                    });
                } else {
                    const json = JSON.parse(await file.text());
                    const fs = json.features || (Array.isArray(json) ? json : [json]);
                    fs.forEach(f => {
                        let c = (f.geometry || f).coordinates;
                        if (c[0] > 180) c = proj4('EPSG:3826', 'WGS84', [c[0], c[1]]);
                        points.push({ lat: c[1], lng: c[0], name: f.properties?.name || "" });
                    });
                }
                if (points.length) { pendingPoints = points; document.getElementById('save-name').value = file.name.split('.')[0]; document.getElementById('save-modal').classList.remove('hidden'); }
            } catch (err) { alert("é»ä½è§£æå¤±æ•—"); }
        };

        document.getElementById('btn-final-upload').onclick = async () => {
            const name = document.getElementById('save-name').value.trim();
            if (!name || !currentUser) return;
            const btn = document.getElementById('btn-final-upload'), statusBox = document.getElementById('upload-status');
            btn.disabled = true; statusBox.classList.remove('hidden');
            const base = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('assets');
            try {
                if (editModeId) await base.doc(editModeId).update({ displayName: name });
                else if (pendingPoints) await base.add({ displayName: name, points: pendingPoints, type: 'point' });
                else if (pendingImg) {
                    if (pendingImg.length > 1048487) throw new Error("File too large");
                    await base.add({ displayName: name, json: pendingJson, img: pendingImg, type: 'img' });
                }
                closeModal();
            } catch (e) { alert("ä¸Šå‚³å¤±æ•—ï¼šåœ–æª”éå¤§"); }
            finally { btn.disabled = false; statusBox.classList.add('hidden'); }
        };

        function setFilter(f) { 
            currentFilter = f; 
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.toggle('active', c.dataset.filter === f));
            renderUI(); 
        }

        function setOpFilter(opName) {
            currentOpFilter = opName;
            document.querySelectorAll('.op-filter-chip').forEach(c => c.classList.toggle('active', c.dataset.op === opName));
            renderUI();
        }

        function setTypeTab(t) {
            currentTypeTab = t;
            document.querySelectorAll('.type-tab').forEach(c => c.classList.toggle('active', c.dataset.type === t));
            renderUI();
        }

        function focusOn(id) { const a = assets.get(id); if (a) { map.fitBounds(a.bounds, { padding: [100, 100] }); openPanel(id); } }

        function openPanel(id) {
            activeId = id; const a = assets.get(id), s = a.statusData;
            document.getElementById('ui-name').innerText = a.name;
            const b = document.getElementById('ui-badge');
            b.innerText = s && s.status !== 'none' ? (s.status === 'done' ? `âœ… å·²å®Œæˆ: ${s.userName}` : `ğŸ‘· ä½œæ¥­ä¸­: ${s.userName}`) : 'é–‹æ”¾èªé ˜';
            b.className = `inline-block px-5 py-3 rounded-full text-lg font-black uppercase tracking-widest ${s?.status === 'done' ? 'bg-emerald-100 text-emerald-600' : (s?.status === 'claimed' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-500')}`;
            document.getElementById('action-panel').classList.remove('hidden');
            renderUI();
        }

        async function updateStatus(status) {
            if (!activeId || !currentUser) return;
            const uName = document.getElementById('user-select').value;
            if (!uName && status !== 'none') return alert("è«‹é¸æ“‡ä½œæ¥­å“¡");
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('status').doc(activeId).set({ status, userName: status === 'none' ? null : uName, ts: firebase.firestore.FieldValue.serverTimestamp() });
            closePanel();
        }

        function editAssetName(id) { editModeId = id; document.getElementById('modal-title').innerText = "ä¿®æ”¹åç¨±"; document.getElementById('save-name').value = assets.get(id).name; document.getElementById('save-modal').classList.remove('hidden'); }
        
        async function deleteAsset(id) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('assets').doc(id).delete(); await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('status').doc(id).delete(); } }

        function startOperatorSync() { 
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('operators').orderBy('name').onSnapshot(snap => { 
                operators = []; 
                snap.forEach(doc => operators.push({ id: doc.id, ...doc.data() })); 
                renderOpUI(); 
                renderOpFilterUI(); 
            }); 
        }

        function renderOpFilterUI() {
            const filterContainer = document.getElementById('op-filter-list');
            const current = currentOpFilter;
            filterContainer.innerHTML = `<div onclick="setOpFilter('all')" class="op-filter-chip px-4 py-1 rounded-full text-slate-500 bg-white ${current === 'all' ? 'active' : ''}" data-op="all">å…¨éƒ¨äººå“¡</div>`;
            operators.forEach(op => {
                const chip = document.createElement('div');
                chip.className = `op-filter-chip px-4 py-1 rounded-full text-slate-500 bg-white ${current === op.name ? 'active' : ''}`;
                chip.dataset.op = op.name;
                chip.innerText = op.name;
                chip.onclick = () => setOpFilter(op.name);
                filterContainer.appendChild(chip);
            });
        }

        function renderOpUI() {
            const sel = document.getElementById('user-select'), list = document.getElementById('op-list'), currentVal = sel.value;
            sel.innerHTML = '<option value="">é¸æ“‡ä½œæ¥­å“¡...</option>';
            operators.forEach(op => { const opt = document.createElement('option'); opt.value = op.name; opt.innerText = op.name; sel.appendChild(opt); });
            sel.value = currentVal;
            list.innerHTML = "";
            operators.forEach(op => {
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-5 bg-slate-50 rounded-2xl border border-slate-100 group";
                item.innerHTML = `<div class="flex items-center gap-4"><div class="w-3 h-3 rounded-full bg-slate-300"></div><span class="font-black text-xl text-[#0f172a]">${op.name}</span></div><div class="flex gap-2"><button onclick="renameOperator('${op.id}', '${op.name}')" class="p-2 text-slate-300 hover:text-blue-500"><i data-lucide="edit-3" class="h-6 w-6"></i></button><button onclick="deleteOperator('${op.id}')" class="p-2 text-slate-300 hover:text-rose-500"><i data-lucide="trash-2" class="h-6 w-6"></i></button></div>`;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        async function addOperator() { const name = document.getElementById('new-op-name').value.trim(); if (name) { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('operators').add({ name }); document.getElementById('new-op-name').value = ""; } }
        async function deleteOperator(id) { if (confirm("ç§»é™¤ï¼Ÿ")) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('operators').doc(id).delete(); }
        async function renameOperator(id, old) { const n = prompt("ä¿®æ”¹å§“åï¼š", old); if (n) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('operators').doc(id).update({ name: n.trim() }); }

        function closeModal() { document.getElementById('save-modal').classList.add('hidden'); editModeId = null; pendingPoints = null; pendingImg = null; }
        function closePanel() { document.getElementById('action-panel').classList.add('hidden'); activeId = null; renderUI(); }
        function openOpManager() { document.getElementById('op-manager-modal').classList.remove('hidden'); }
        function closeOpManager() { document.getElementById('op-manager-modal').classList.add('hidden'); }

        window.onload = init;
    </script>
</body>
</html>
